"use strict";!function(t){function e(t,e){return Array.isArray(t)?t.indexOf(e)<0?t.concat(e):t.slice():[e]}function n(t,e){return Math.max.apply(0,t.map(function(t){return t[e]||0}))}function r(t){return e(t,a())}function a(){return moment().format("dddd")}function i(t,e){return t.find(function(t){return t.id===e})||{id:e}}function o(t,e){return m(t).then(function(n){return y({id:t,tableNumber:e,seatedDays:r(n.seatedDays),seatedLast:moment().format(),standbyOrder:null,lotteryOrder:null})})}function s(t){return f().then(function(e){return y({id:t,standbyOrder:n(e,"standbyOrder")+1,lotteryOrder:null,tableNumber:null,roomNumber:null,standbyDays:r(i(e,t).standbyDays)})})}function d(t,e){return y({id:t,tableNumber:null,lotteryOrder:null,standbyOrder:null,lotteryEligible:e,roomNumber:null})}function l(t){return f().then(function(e){return y({id:t,lotteryOrder:n(e,"lotteryOrder")+1,standbyOrder:null,tableNumber:null,roomNumber:null})})}function u(){return Database.open().artists.clear().then(h)}function c(t){return Database.open().artists["delete"](+t).then(h)}function f(){return Database.open().artists.toArray()}function m(t){return Database.open().artists.get(+t)}function b(t){return Database.transaction(function(){t.forEach(function(t){var e=!t.id,n=Object.assign({},t);delete n.id,e?Database.open().artists.put(n):Database.open().artists.update(+t.id,n)}),Database.incrementTableVersion("artists")})}function y(t){return b([t])}function h(){return Database.incrementTableVersion("artists")}t.Artists={addLottery:l,appendToday:r,clear:u,"delete":c,get:m,getAll:f,set:y,setAll:b,setSeated:o,setStandby:s,setSignedOut:d}}(window),function(t){function e(){if(!l){var t=new Dexie("ArtTrackPlus2");t.version(1).stores({artists:["++id","name","badgeNumber","tableNumber","roomNumber","phone","remarks","lotteryEligible","lotteryGuaranteed","lotteryOrder","seatedLast","seatedDays","standbyDays","standbyOrder"].join(),tableVersions:["++id","artists"].join()}),t.open()["catch"](a),Dexie.Promise.on("error",a),l=t}return l}function n(t){return e()[t].schema}function r(){var t=new Error;return t.stack}function a(t){var e="Dexie has encountered an error: "+t+"\n\n"+r();console.error(e)}function i(){var t=e();return l=null,t["delete"]()}function o(t){return e().transaction("rw",["artists","tableVersions"],t)}function s(){return e().tableVersions.get(1)}function d(t){return s(t).then(function(n){return n||(n={id:1}),n[t]||(n[t]=0),n[t]++,e().tableVersions.put(n)})}var l;t.Database={"delete":i,getSchema:n,getTableVersion:s,incrementTableVersion:d,open:e,transaction:o}}(window),function(t){function e(t){return m(u(t,"lotteryOrder"))}function n(t){return u(t,"lotteryEligible")}function r(t){return u(t,"lotteryGuaranteed")}function a(t){return l(t,"lotteryOrder")}function i(t){return m(u(t,"tableNumber"))}function o(t){return f(u(t,"tableNumber"),"tableNumber")}function s(t){return m(u(t,"standbyOrder"))}function d(t){return l(t,"standbyOrder")}function l(t,e,n){return c(u(t,e),n||e)}function u(t,e){return t.filter(function(t){return!!t[e]})}function c(t,e){return t.slice().sort(function(t,n){var r=t[e],a=n[e];return r>a?1:a>r?-1:0})}function f(t,e){return t.slice().sort(function(t,n){var r=+t[e],a=+n[e];return r>a?1:a>r?-1:0})}function m(t){return t.slice().sort(function(t,e){var n=(t.name||"").toLocaleLowerCase(),r=(e.name||"").toLocaleLowerCase();return n>r?1:r>n?-1:0})}t.Filter={lottery:e,lotteryEligible:n,lotteryGuaranteed:r,lotteryInOrder:a,seated:i,seatedInOrder:o,sorted:m,standby:s,standbyInOrder:d}}(window),function(t){function e(){var t={name:"Test "+(n(9e3)+1e3),badgeNumber:n(1e4)+1,phone:r([null,i()]),remarks:r([null,"Etc Whatever"]),lotteryEligible:a()};return t}function n(t){return Math.floor(Math.random()*t)}function r(t){return t[n(t.length)]}function a(){return Math.random()>=.5}function i(){var t=r([".","-",""]),e=r(["","1"+t]);return e+(n(800)+200)+t+(n(800)+200)+t+(n(9e3)+1e3)}t.Generator={getRandomArtist:e}}(window),function(t){function e(t){t.forEach(function(t){t.lotteryOrder=null,t.standbyOrder=null,t.tableNumber=null})}function n(t){var e=t.length;t.forEach(function(n,r){var a=Math.floor(Math.random()*e),i=t[r];t[r]=t[a],t[a]=i})}function r(t){Artists.getAll().then(function(r){var a=Filter.lotteryEligible(r);e(r),n(a);var i=1;a.forEach(function(e){t>0&&e.lotteryGuaranteed&&(e.lotteryOrder=i++,t--)});var o=1;a.forEach(function(e){e.lotteryOrder||(t>0?(e.lotteryOrder=i++,t--):(e.standbyOrder=o++,e.standbyDays=Artists.appendToday(e.standbyDays)))}),Artists.setAll(a)})}t.Lottery={reset:e,run:r}}(window),function(t){function e(t){p&&p(t)}function n(){p&&p($("#prompt-dialog input").val())}function r(t){$("#artist-id").text(t.id||"0"),$("#artist-name").val(t.name||""),$("#artist-badge").val(t.badgeNumber||""),$("#artist-table").val(t.tableNumber||""),$("#artist-room").val(t.roomNumber||""),$("#artist-phone").val(t.phone||""),$("#artist-remarks").val(t.remarks||""),$("#artist-lottery-eligible").prop("checked",t.lotteryEligible||!1),$("#artist-lottery-guaranteed").prop("checked",t.lotteryGuaranteed||!1),$("#artist-seated-last").text(t.seatedLast?moment(t.seatedLast).calendar():"Never"),$("#artist-seated-days").text(t.seatedDays||"Never"),$("#artist-standby-days").text(t.standbyDays||"Never")}function a(t,e){v=!!t,r({lotteryEligible:!0}),$("#artist-detail-mode").text("New Artist "),$(".artist-add-only").show(),$(".artist-edit-only").hide(),e||$("#artist-detail").modal()}function i(){$("#batch-sign-out").modal()}function o(){Artists.getAll().then(function(t){var e=$("<div/>");t=Filter.seatedInOrder(t),t.forEach(function(t){var n=$("<p/>").addClass("form-control-static").text(t.name),r=$("<p/>").addClass("form-control-static").text(t.tableNumber),a=$('<input type="text">').addClass("form-control").attr("id","bulk-artist-room-number-"+t.id).attr("value",t.roomNumber).attr("data-artist-id",t.id);e.append($("<tr/>").append($("<td/>").append(n)).append($("<td/>").append(r)).append($("<td/>").append(a)))}),$("#bulk-artist-room-table").html(e.html()),$("#bulk-artist-room-table input[type=text]").last().keydown(function(t){13===t.which&&(t.preventDefault(),window.setTimeout(function(){$("[data-save=rooms]").focus()},10))}),$("#bulk-artist-room").modal(),$("#bulk-artist-room .room-content").each(function(){var t=$(this);t.hasClass("scroll-added")||(t.addClass("scroll-added"),t.slimScroll({height:"100%"}))})})}function s(t){Artists.get(t).then(function(t){r(t),$("#artist-detail-mode").text((t.name||"Edit Artist")+" "),$(".artist-add-only").hide(),$(".artist-edit-only").show(),$("#artist-detail").modal()})}function d(){$("#raw-editor").modal()}function l(){$("#reset-dialog").modal()}function u(){Artists.getAll().then(function(t){t.some(function(t){return!!t.tableNumber})?m("Lottery can't be run. Artists are signed in yet."):$("#run-lottery").modal()})}function c(){$("#generate-dialog").modal()}function f(t){var e=$("[data-edit-raw=artist]");t?Artists.get(t).then(function(t){console.log(t),t?(delete t.id,e.val(JSON.stringify(t,null,2))):e.val("")}):e.val("")}function m(t,e){t&&($("#alert-title").text(e||"Notice"),$("#alert-body").text(t),$("#alert-dialog").modal())}function b(t,e,n){p=n,t&&($("#confirm-title").text(e||"Confirmation Needed"),$("#confirm-body").text(t),$("#confirm-dialog").modal())}function y(t,e,n){p=n,t&&($("#prompt-dialog input").val(""),$("#prompt-title").text(e||"Input Needed"),$("#prompt-body").text(t),$("#prompt-dialog").modal())}function h(t,e,n){p=n,t&&($("#yes-no-cancel-title").text(e||"Confirmation Needed"),$("#yes-no-cancel-body").text(t),$("#yes-no-cancel-dialog").modal())}t.Modal={addArtist:a,alert:m,batchSignOut:i,bulkArtistRoom:o,confirm:b,confirmConfirm:e,editArtist:s,editArtistRaw:d,prompt:y,promptConfirm:n,resetDatabase:l,runLottery:u,seedDatabase:c,setRawArtistId:f,showYesNoCancel:h};var p,v=!1;$(function(){function t(){return Number($("#artist-id").text())}function r(){var e={};e.id=t(),e.name=$("#artist-name").val(),e.badgeNumber=$("#artist-badge").val(),e.tableNumber=$("#artist-table").val(),e.roomNumber=$("#artist-room").val(),e.phone=$("#artist-phone").val(),e.remarks=$("#artist-remarks").val(),e.lotteryEligible=$("#artist-lottery-eligible").prop("checked"),e.lotteryGuaranteed=$("#artist-lottery-guaranteed").prop("checked"),e.tableNumber&&(e.lotteryOrder=0,e.standbyOrder=0),Artists.set(e)}function i(){var t=[];$("#bulk-artist-room-table input[type=text]").each(function(){var e=$(this),n=e.attr("data-artist-id");n&&t.push({id:n,roomNumber:e.val()})}),Artists.setAll(t)}$("#artist-detail input[type=text]").last().keydown(function(t){13===t.which&&(t.preventDefault(),v?(r(),a(v,!0),window.setTimeout(function(){$("#artist-detail input").first().focus()},10)):$("[data-save=artist]:visible").trigger("click"))}),$("[data-delete=artist]").click(function(){b("Really delete this artist?","Delete Artist Confirmation",function(e){e&&Artists["delete"](t())})}),$("[data-save=artist]").click(function(){r()}),$("[data-save=rooms]").click(function(){i()}),$("[data-standby=artist]").click(function(){var e=function(t){Artists.setStandby(n).then(function(){Artists.getAll().then(function(e){var n=Filter.standbyInOrder(e).length;m("The artist is #"+n+" in standby.","Add "+t.name+" to Standby List")})})},n=t();Artists.get(n).then(function(t){var n="Add "+t.name+" to Standby List";t.standbyOrder?b("This artist is already on standby. Move them to the bottom of the list?",n,function(n){n&&e(t)}):e(t)})}),$("[data-signin=artist]").click(function(){Artists.get(t()).then(function(e){y("Enter a table number.","Sign In for "+e.name,function(e){e&&Artists.setSeated(t(),e)})})}),$("[data-signout=artist]").click(function(){Artists.get(t()).then(function(e){var n="Signing out "+e.name;e.tableNumber||e.standbyOrder||e.lotteryOrder?h("Would this artist like to be included in tomorrow's lottery?",n,function(e){(e===!0||e===!1)&&Artists.setSignedOut(t(),!!e)}):m("This artist is already signed out.",n)})}),$("[data-select-raw=artist]").change(function(){var t=$(this).find(":selected"),e=t.attr("value");f(e)}),$("[data-prompt-confirm]").click(function(){n()}),$("[data-confirm-confirm]").click(function(){e(!0)}),$("[data-confirm-deny]").click(function(){e(!1)}),$("[data-confirm-cancel]").click(function(){e(null)}),$("#prompt-dialog input").keydown(function(t){13===t.which&&(t.preventDefault(),$("[data-prompt-confirm]").trigger("click"))})})}(window),function(t){function e(t){return $("<i/>").addClass("fa fa-"+t)}function n(t){return $("<span/>").addClass(t)}function r(){Artists.getAll().then(function(t){var e=Filter.sorted(t),n=Filter.standbyInOrder(t),r=Filter.seated(t),o=Filter.lotteryInOrder(t),s=Filter.lottery(t);i($(".artist-names"),e,{withSymbols:!0}),i($(".lottery-names"),o,{withOrder:!0}),i($(".standby-names"),n,{withOrder:!0}),i($(".seated-names"),r),i($(".lottery-sorted-names"),s,{disableClick:!0}),i($(".standby-sorted-names"),n,{disableClick:!0}),i($(".seated-sorted-names"),r,{disableClick:!0}),a($("[data-select-raw=artist]"),e),$(".count-artists").text(t.length),$(".count-lottery").text(o.length),$(".count-standby").text(n.length),$(".count-seated").text(r.length)})}function a(t,e){var n=$("<div/>");n.append($("<option/>").text("(select one...)")),e.forEach(function(t){n.append($("<option/>").attr("value",t.id).text(t.name))}),t.html(n.html())}function i(t,r,a){a=$.extend({disableClick:!1,withSymbols:!1,withOrder:!1},a||{}),t.empty(),r.forEach(function(r,i){var s=$("<a/>").addClass("line").text(r.name+" ");if(a.withOrder&&s.prepend(n("artist-order").text(""+(i+1)+".")),r.tableNumber){var d=n("artist-seat");d.text("#"+r.tableNumber),s.append(d)}if(a.withSymbols){var l=n("artist-symbols"),u=!r.seatedLast&&r.standbyDays&&r.standbyDays.length>=2;r.lotteryOrder>0&&l.append(e("check faded")),r.standbyOrder>0&&l.append(e("clock-o faded")),r.tableNumber&&l.append(e("sign-in faded")),u&&l.append(e("exclamation attention")),l.html().length>0&&s.append(l)}t.append(s),a.disableClick||s.attr("href","#").click(o(r.id))})}function o(t){return function(){s(t)}}function s(t){Modal.editArtist(t)}t.Names={populate:r}}(window),function(t){function e(t){t.forEach(function(t){t()})}function n(t){a.push(t)}function r(){o||(Database.getTableVersion("artists").then(function(t){t||(t={id:1},Database.open().tableVersions.put(t)),t.artists!==i&&(console.log("Update requested. New version "+t.artists),i=t.artists,e(a)),o=!1}),o=!0)}t.Scheduler={onArtistChange:n};var a=[],i=-1,o=!1;$(function(){window.setInterval(r,500)})}(window),function(t){function e(){var t=$(window).width(),e=0;if(t>960){var n=$(".screen:visible").width();e=(t-n)/2}$(".screen").css("marginLeft",e)}function n(t){$('.screen[id!="'+t+'"]').hide();var n=$(".screen#"+t);if(n.length>0){n.hasClass("hide-nav")&&($("nav").remove(),$(".screen").css("padding-top",0)),n.show(),e();var r=n.find(".content");r.hasClass("scroll-added")||(r.addClass("scroll-added"),r.slimScroll({height:"100%",size:"12px",alwaysVisible:!0}))}}t.Screen={reposition:e,select:n}}(window),function(t){function e(t,e,n){return Modal.prompt("Confirm by typing '"+t+"' into the box below.",e||"Confirmation",function(e){e===t&&n()})}function n(){e("close","Close Out Day",function(){return Artists.getAll().then(function(t){return Database.transaction(function(){var e;return t.forEach(function(t){t.tableNumber?e=Artists.setSignedOut(t.id,!1):(t.standbyOrder||t.lotteryOrder)&&(e=Artists.setSignedOut(t.id,!0))}),e})})})}function r(){return Artists.getAll().then(function(t){var e="",n=["name","badgeNumber","tableNumber","roomNumber","phone","remarks","seatedLast","seatedDays","standbyDays"];e+=n.join(",")+"\r\n",t.forEach(function(t){var r=[];n.forEach(function(e){var n=t[e];n=n===!1?"N":n===!0?"Y":0===n||n?Array.isArray(n)?n.join("|"):""+n:null,n=null!==n?'"'+n.replace(/"/g,'""')+'"':"",r.push(n)}),e+=r.join(",")+"\r\n"});var r=window.document.createElement("a");r.href=window.URL.createObjectURL(new Blob([e],{type:"text/csv"})),r.download="Artists.csv",document.body.appendChild(r),r.click(),document.body.removeChild(r)})}function a(t){return Artists.getAll().then(function(e){var n=e.filter(t);n.length>0?Modal.editArtist(n[0].id):Modal.alert("No matching artists were found.","Search Results")})}function i(t,e){var n=""+e;return a(function(e){return!!e[t]&&""+e[t]===n})}function o(){Modal.prompt("Enter badge number.","Find Artist by Badge Number",function(t){t&&i("badgeNumber",t)})}function s(){Modal.prompt("Enter table number.","Find Artist by Table Number",function(t){t&&i("tableNumber",t)})}function d(){Modal.addArtist(!0)}function l(){e("reset","Wipe Everything",Artists.clear)}function u(){Modal.prompt("How many seats?","Run Lottery",function(t){if(t){var e=+t;e>0&&Lottery.run(e)}})}function c(){try{var t=+$("[data-select-raw]").find(":selected").attr("value");if(t){var e=JSON.parse($("[data-edit-raw]").val());e.id=t,Artists.set(e).then(function(){Modal.alert("The artist was saved successfully.")})}}catch(n){Modal.alert("The artist could not be saved:\n"+n.message)}}function f(){e("generate","Generate Test Data",function(){Artists.clear().then(function(){for(var t=[],e=0;200>e;e++)t.push(Generator.getRandomArtist());return Artists.setAll(t)})})}t.SystemActions={batchSignOut:n,exportCsv:r,findArtistByBadge:o,findArtistByTable:s,newArtistRapidEntry:d,resetDatabase:l,runLottery:u,saveArtistRaw:c,seedDatabase:f}}(window),$(function(){function t(){var t=window.location.hash.substring(1);t&&0!==t.length||(t="main"),Screen.select(t)}function e(){$(window).resize(Screen.reposition)}function n(){$("a[data-modal]").each(function(t,e){var n=$(e),r=n.attr("data-modal");n.attr("href","#").click(function(){Modal[r]()})})}function r(){$("a[data-screen]").each(function(t,e){var n=$(e),r=n.attr("data-screen");n.attr("href","#"+r).click(function(){Screen.select(r)})})}function a(){$("[data-system-action]").each(function(t,e){var n=$(e),r=n.attr("data-system-action");n.click(function(){SystemActions[r]()})})}n(),r(),t(),e(),a(),Scheduler.onArtistChange(Names.populate),$(function(){function t(){$("body").addClass("modal-open");var t=$(".modal.in").length+1050+1,e=t-1;$(".modal-backdrop").addClass("hidden"),$(".modal.in:last").css("z-index",t),$(".modal-backdrop.in:last").css("z-index",e).removeClass("hidden")}$(document).on("show.bs.modal",".modal",function(){$(this).appendTo($("body"))}).on("shown.bs.modal",".modal.in",function(){t()}).on("hidden.bs.modal",".modal",function(){t(),0===$(".modal.in").length&&$("body").removeClass("modal-open")})})}),$(function(){JoelPurra.PlusAsTab.setOptions({key:13}),$(document).on("shown.bs.modal",".modal",function(){$(this).find("[autofocus]").focus()})});